<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Results Visualization</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.7/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.7/survey.i18n.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.7/themes/index.min.js"></script>
    <script src="https://unpkg.com/survey-js-ui@1.12.7/survey-js-ui.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/survey-core@1.12.7/defaultV2.min.css" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        #loadingIcon {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: #555;
            text-align: center;
        }
        #loadingIcon .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chartContainer {
            width: 80%;
            max-width: 1200px;
            height: 600px;
            margin: 20px auto 0;
            display: none;
        }
        @media (max-width: 768px) {
            #chartContainer {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <script src="./theme.js"></script>
    <div id="chartContainer"></div>
    <div id="surveyContainer"></div>
    <div id="userAnswers" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none;"></div>
    <div id="debugInfo" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none;">
        <h3>Debug Information:</h3>
        <pre id="debugOutput"></pre>
    </div>
    <div id="loadingIcon">
        <div class="spinner"></div>
        <p style="text-align: center;">Now let's load all the responses so you can compare your answers</p>
    </div>
    <script>
        // Debug flag to control the visibility of debug information
        const DEBUG_MODE = false;

        // Debug logging function
        function debugLog(message, data = null) {
            if (DEBUG_MODE) {
                const timestamp = new Date().toISOString();
                const logMessage = `${timestamp}: ${message}`;
                console.log(logMessage);
                if (data) {
                    console.log(data);
                }
                // Also display in the UI
                const debugOutput = document.getElementById('debugOutput');
                debugOutput.textContent += logMessage + '\n';
                if (data) {
                    debugOutput.textContent += JSON.stringify(data, null, 2) + '\n';
                }
                // Make debug info visible
                document.getElementById('debugInfo').style.display = 'block';
            }
        }

        let userID = 'Unknown User';

        // Listen for messages from the parent window (Moodle page)
        window.addEventListener('message', function(event) {
            if (event.origin !== "https://my.etonx.com/mod/page/view.php?id=33795") { // Change this to your Moodle domain
                return;
            }
            if (event.data && event.data.type === 'MOODLE_USER_ID') {
                userID = event.data.userID;
                debugLog('Received Moodle user ID from parent:', userID);
            }
        }, false);

        $(document).ready(function () {
            debugLog('Application initialized');

            // Request the Moodle user ID from the parent window
            window.parent.postMessage({ type: 'REQUEST_USER_ID' }, "https://my.etonx.com");

            const json = {
                "questions": [
                    {
                        "type": "matrix",
                        "name": "Proof and Doubt",
                        "columns": [
                            "A: proved beyond all possible doubt.",
                            "B: proved beyond all reasonable doubt.",
                            "C: not proved beyond all reasonable doubt."
                        ],
                        "rows": [
                            "Grass is green.",
                            "Trees exist.",
                            "You exist.",
                            "Paris is the capital of France.",
                            "There isn't life beyond Earth.",
                            "The Earth goes around the Sun."
                        ]
                    }
                ],
                  "showNavigationButtons": "none",
                  "showTitle": false,
                  "showPageTitles": false,
                  "showCompletedPage": false,
                  "showQuestionNumbers": "off",
                  "goNextPageAutomatic": true,
                  "completeText": "Submit Answers",
                  "widthMode": "responsive"
            };

            var survey = new Survey.Model(json);
            debugLog('Survey model created');

            survey.onComplete.add(function (result) {
                debugLog('Survey completed, processing results:', result.data);
                try {
                    const resultData = result.data;
                    const queryParams = new URLSearchParams();

                    // Append user ID to the query parameters
                    queryParams.append('userID', userID);

                    Object.entries(resultData).forEach(([key, value]) => {
                        queryParams.append(key, typeof value === 'object' ? JSON.stringify(value) : value);
                    });

                    const url = 'https://script.google.com/macros/s/AKfycbyrcC2mO_FJJwPmk4x_O4xz5iLjYl3m73FByzYN3nwM6Zn1BGEmlKW2WRrpzFYSFc6v/exec' + '?' + queryParams.toString();
                    debugLog('Submitting to URL:', url);

                    // Show loading icon while fetching data
                    document.getElementById('loadingIcon').style.display = 'block';

                    fetch(url, {
                        method: 'GET',
                        mode: 'cors'
                    })
                    .then(response => {
                        debugLog('Received response from server');
                        return response.json();
                    })
                    .then(data => {
                        debugLog('Processed response data:', data);
                        if (data.result === 'success') {
                            document.getElementById('chartContainer').style.display = 'block';
                            drawChart();
                        } else {
                            throw new Error(data.message || 'Unknown error occurred');
                        }
                    })
                    .catch(error => {
                        debugLog('Error in survey submission:', error);
                        console.error('Error submitting survey:', error);
                        alert('Failed to submit survey. Please try again.');
                    })
                    .finally(() => {
                        // Hide loading icon
                        document.getElementById('loadingIcon').style.display = 'none';
                    });
                } catch (error) {
                    debugLog('Error in survey completion handler:', error);
                    console.error('Error processing survey submission:', error);
                    alert('An error occurred while processing your submission.');
                }
            });

            $("#surveyContainer").Survey({ model: survey });
            survey.applyTheme(themeJson);
            debugLog('Survey rendered to container');

            google.charts.load('current', { packages: ['corechart'] });
            google.charts.setOnLoadCallback(() => {
                debugLog('Google Charts loaded');
            });

            function drawChart() {
                debugLog('Starting chart drawing process');
                const sheetID = '1gOjtFLqz6k8qkv3o5BAAIE9pi5tul6d8urlcCNJ5QB8';
                const queryUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=Sheet1`;
                debugLog('Querying spreadsheet:', queryUrl);
                
                const query = new google.visualization.Query(queryUrl);
                query.setQuery('SELECT *');  // Explicitly select all data
                query.send(handleQueryResponse);
            }

            function handleQueryResponse(response) {
                if (response.isError()) {
                    debugLog('Error in spreadsheet query:', {
                        message: response.getMessage(),
                        detailedMessage: response.getDetailedMessage()
                    });
                    return;
                }

                try {
                    const data = response.getDataTable();
                    debugLog('Received data table:', {
                        numberOfRows: data.getNumberOfRows(),
                        numberOfColumns: data.getNumberOfColumns()
                    });

                    // Log the raw data
                    const rawData = [];
                    for (let i = 0; i < data.getNumberOfRows(); i++) {
                        const row = [];
                        for (let j = 0; j < data.getNumberOfColumns(); j++) {
                            row.push(data.getValue(i, j));
                        }
                        rawData.push(row);
                    }
                    debugLog('Raw data from spreadsheet:', rawData);

                    // Create processed data table
                    const processedData = new google.visualization.DataTable();
                    processedData.addColumn('string', 'Question');
                    const responseTypes = ['A: proved beyond all possible doubt.', 'B: proved beyond all reasonable doubt.', 'C: not proved beyond all reasonable doubt.'];
                    responseTypes.forEach(type => {
                        processedData.addColumn('number', `${type} (%)`);
                    });

                    // Process each question's responses
                    const questions = json.questions[0].rows;
                    debugLog('Processing questions:', questions);

                    questions.forEach((question, questionIndex) => {
                        const responseCounts = new Array(3).fill(0);
                        let totalResponses = 0;

                        // Count responses for this question
                        for (let row = 0; row < data.getNumberOfRows(); row++) {
                            const response = data.getValue(row, questionIndex + 1);
                            const responseIndex = responseTypes.indexOf(response);
                            if (responseIndex !== -1) {
                                responseCounts[responseIndex]++;
                                totalResponses++;
                            }
                        }

                        debugLog(`Response counts for "${question}":`, {
                            counts: responseCounts,
                            total: totalResponses
                        });

                        // Calculate and add percentages
                        const percentages = totalResponses > 0
                            ? responseCounts.map(count => (count / totalResponses) * 100)
                            : [0, 0, 0];
                        processedData.addRow([question, ...percentages]);
                    });

                    const options = {
                        title: 'Survey Results - Response Distribution (%)',
                        hAxis: { title: 'Survey Statements', titleTextStyle: { italic: true, bold: true }, showTextEvery: 1 },
                        vAxis: { title: 'Percentage', titleTextStyle: { italic: true, bold: true }, minValue: 0, maxValue: 100 },
                        isStacked: true,
                        legend: { position: 'top', maxLines: 3 },
                        colors: ['#1a9850', '#fee08b', '#d73027'], // Green for A, Orange for B, Red for C
                        chartArea: { width: '90%', height: '75%' }
                    };

                    const chart = new google.visualization.ColumnChart(document.getElementById('chartContainer'));
                    chart.draw(processedData, options);
                    debugLog('Chart drawn successfully');
                } catch (error) {
                    debugLog('Error in handling query response:', error);
                    console.error('Error handling query response:', error);
                }
            }
        });
    </script>
</body>
</html>
