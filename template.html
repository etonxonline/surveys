<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Results Visualization</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.7/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.7/survey.i18n.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.7/themes/index.min.js"></script>
    <script src="https://unpkg.com/survey-js-ui@1.12.7/survey-js-ui.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/survey-core@1.12.7/defaultV2.min.css" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        #loadingIcon {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: #555;
            text-align: center;
        }
        #loadingIcon .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chartContainer {
            width: 80%;
            max-width: 1200px;
            height: 600px;
            margin: 20px auto 0;
            display: none;
        }
        @media (max-width: 768px) {
            #chartContainer {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    LOL
    <script src="./theme.js"></script>
    <div id="chartContainer"></div>
    <div id="surveyContainer"></div>
    <div id="userAnswers" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none;"></div>
    <div id="debugInfo" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none;">
        <h3>Debug Information:</h3>
        <pre id="debugOutput"></pre>
    </div>
    <div id="loadingIcon">
        <div class="spinner"></div>
        <p style="text-align: center;">Now let's load all the responses so you can compare your answers</p>
    </div>

    <script>
    // Debug flag to control the visibility of debug information
    const DEBUG_MODE = true;

    // Debug logging function
    function debugLog(message, data = null) {
        if (DEBUG_MODE) {
            const timestamp = new Date().toISOString();
            const logMessage = `${timestamp}: ${message}`;
            console.log(logMessage);
            if (data) {
                console.log(data);
            }
            // Also display in the UI
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.textContent += logMessage + '\n';
            if (data) {
                debugOutput.textContent += JSON.stringify(data, null, 2) + '\n';
            }
            // Make debug info visible
            document.getElementById('debugInfo').style.display = 'block';
        }
    }

    let userID = 'Unknown User';
    let userIDReceived = false;

    // Listen for messages from the parent window (Moodle page)
    window.addEventListener('message', function(event) {
        debugLog('Received message from parent:', event);
        const allowedOrigins = ["https://my.etonx.com"];
        if (!allowedOrigins.includes(event.origin)) {
            debugLog('Ignoring message from unknown origin:', event.origin);
            return;
        }
        if (event.data && event.data.type === 'MOODLE_USER_ID') {
            userID = event.data.userID;
            userIDReceived = true;
            debugLog('Received Moodle user ID from parent:', userID);
        }
    }, false);

    $(document).ready(function () {
        debugLog('Application initialized');

        // Request the Moodle user ID from the parent window
        window.parent.postMessage({ type: 'REQUEST_USER_ID' }, "*");
        debugLog('Requesting Moodle user ID from parent window.');

        // Load external config file
        $.getJSON('config.json', function(config) {
            const jsonFilePath = config.jsonFile;
            const googleScriptUrl = config.googleScriptUrl;
            const spreadsheetID = config.spreadsheetID;

            // Load the survey JSON dynamically
            $.getJSON(jsonFilePath, function(surveyJson) {
                fetchSurveyDataAndCheckUser(spreadsheetID, surveyJson, googleScriptUrl);
            });
        });
    });

    function fetchSurveyDataAndCheckUser(spreadsheetID, surveyJson, googleScriptUrl) {
        google.charts.load('current', { packages: ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            const queryUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetID}/gviz/tq?sheet=Sheet1`;
            debugLog('Querying spreadsheet for user check:', queryUrl);

            const query = new google.visualization.Query(queryUrl);
            query.setQuery('SELECT *');
            query.send(function(response) {
                handleUserCheckResponse(response, surveyJson, googleScriptUrl);
            });
        });
    }

    function handleUserCheckResponse(response, surveyJson, googleScriptUrl) {
        if (response.isError()) {
            debugLog('Error in spreadsheet query:', {
                message: response.getMessage(),
                detailedMessage: response.getDetailedMessage()
            });
            return;
        }

        const data = response.getDataTable();
        let userExists = false;
        let userRowData = null;

        // Iterate through the rows and check if the userID exists (skip if userID is 'Unknown')
        for (let row = 0; row < data.getNumberOfRows(); row++) {
            const storedUserID = data.getValue(row, 1);  // The userID is in the second column

            if (storedUserID === userID && userID !== 'Unknown User') {
                userExists = true;
                userRowData = data;
                break;
            }
        }

        if (userExists) {
            debugLog('User already exists, skipping survey and showing chart.');
            showPreExistingResults(userRowData, surveyJson);  // Display existing data and chart
        } else {
            debugLog('User does not exist, rendering survey.');
            renderSurvey(surveyJson, googleScriptUrl);  // Allow user to complete the survey
        }
    }

    function showPreExistingResults(userRowData, surveyJson) {
        // Show the chart with the user's original answers
        document.getElementById('chartContainer').style.display = 'block';

        // Draw the chart with existing data
        drawChart(userRowData, surveyJson);

        // Display the user's original answers below the chart
        const userAnswersContainer = document.getElementById('userAnswers');
        userAnswersContainer.style.display = 'block';
        userAnswersContainer.innerHTML = `<strong>Your previous answers:</strong><br>`;

        const questions = surveyJson.questions[0].rows;
        for (let i = 0; i < questions.length; i++) {
            userAnswersContainer.innerHTML += `${questions[i]}: ${userRowData.getValue(0, i + 2)}<br>`;  // Displaying from 3rd column
        }
    }

    function renderSurvey(surveyJson, googleScriptUrl) {
        const survey = new Survey.Model(surveyJson);
        $("#surveyContainer").Survey({ model: survey });

        survey.onComplete.add(function (result) {
            debugLog('Survey completed, processing results:', result.data);
            submitSurveyData(result.data, surveyJson, googleScriptUrl);
        });
    }

    function submitSurveyData(surveyData, surveyJson, googleScriptUrl) {
        debugLog('Submitting survey data:', surveyData);  // Add this line to log the survey data

        const queryParams = new URLSearchParams();
        Object.entries(surveyData).forEach(([key, value]) => {
            queryParams.append(key, typeof value === 'object' ? JSON.stringify(value) : value);
        });

        // Add user ID to the query params
        queryParams.append('userID', userID);

        const url = `${googleScriptUrl}?${queryParams.toString()}`;
        debugLog('Submitting to Google Script URL:', url);  // Add this line to log the submission URL

        // Show loading icon while fetching data
        document.getElementById('loadingIcon').style.display = 'block';

        fetch(url, {
            method: 'GET',
            mode: 'cors'
        })
        .then(response => response.json())
        .then(data => {
            debugLog('Processed response data:', data);  // Log the response data
            if (data.result === 'success') {
                document.getElementById('chartContainer').style.display = 'block';
                fetchSurveyDataAndRenderChart(spreadsheetID, surveyJson);
            } else {
                throw new Error(data.message || 'Unknown error occurred');
            }
        })
        .catch(error => {
            debugLog('Error in survey submission:', error);  // Log the error here
            alert('Failed to submit survey. Please try again.');
        })
        .finally(() => {
            // Hide loading icon
            document.getElementById('loadingIcon').style.display = 'none';
        });
    }
    function fetchSurveyDataAndRenderChart(spreadsheetID, surveyJson) {
        google.charts.load('current', { packages: ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            const queryUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetID}/gviz/tq?sheet=Sheet1`;
            debugLog('Querying spreadsheet for chart data:', queryUrl);
    
            const query = new google.visualization.Query(queryUrl);
            query.setQuery('SELECT *');
            query.send((response) => handleQueryResponse(response, surveyJson));
        });
    }

    function handleQueryResponse(response, surveyJson) {
        if (response.isError()) {
            debugLog('Error in spreadsheet query:', {
                message: response.getMessage(),
                detailedMessage: response.getDetailedMessage()
            });
            return;
        }
    
        try {
            const data = response.getDataTable();
            debugLog('Fetched data table for chart rendering:', data);  // Log the fetched data
    
            // Ensure the data is processed correctly
            drawChart(data, surveyJson);
        } catch (error) {
            debugLog('Error in handling query response for chart rendering:', error);
        }
    }




    function drawChart(data, surveyJson) {
        const processedData = new google.visualization.DataTable();
        processedData.addColumn('string', 'Question');

        // Dynamically add columns from the survey JSON matrix columns
        const matrixColumns = surveyJson.questions[0].columns;
        matrixColumns.forEach(column => {
            processedData.addColumn('number', `${column} (%)`);
        });

        debugLog('Processing questions for chart:', surveyJson.questions[0].rows);

        // Process each question (row) dynamically
        const questions = surveyJson.questions[0].rows;
        questions.forEach((question, questionIndex) => {
            const responseCounts = new Array(matrixColumns.length).fill(0);
            let totalResponses = 0;

            // Count responses for each question (starting from the 3rd column in the data)
            for (let row = 0; row < data.getNumberOfRows(); row++) {
                const response = data.getValue(row, questionIndex + 2);  // Shift index by 2 to skip timestamp and userID
                const responseIndex = matrixColumns.indexOf(response);
                if (responseIndex !== -1) {
                    responseCounts[responseIndex]++;
                    totalResponses++;
                }
            }

            debugLog(`Response counts for "${question}":`, responseCounts);

            const percentages = totalResponses > 0
                ? responseCounts.map(count => (count / totalResponses) * 100)
                : new Array(matrixColumns.length).fill(0);

            processedData.addRow([question, ...percentages]);
        });

        const options = {
            title: 'Survey Results - Response Distribution (%)',
            hAxis: { title: 'Survey Statements' },
            vAxis: { title: 'Percentage', minValue: 0, maxValue: 100 },
            isStacked: true,
            legend: { position: 'top', maxLines: 3 },
            chartArea: { width: '90%', height: '75%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chartContainer'));
        chart.draw(processedData, options);
    }
    </script>

</body>
</html>
